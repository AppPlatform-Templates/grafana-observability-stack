spec:
  name: grafana-observability
  region: nyc

  services:
    # Loki - Log aggregation system
    - name: loki
      git:
        repo_clone_url: https://github.com/AppPlatform-Templates/grafana-observability-stack.git
        branch: main
      dockerfile_path: loki/Dockerfile
      source_dir: /

      http_port: 3100

      health_check:
        http_path: /ready
        initial_delay_seconds: 30
        period_seconds: 10
        timeout_seconds: 5
        failure_threshold: 3

      envs:
        - key: SPACES_ENDPOINT
          value: ${SPACES_ENDPOINT}
          type: GENERAL
        - key: SPACES_BUCKET
          value: ${SPACES_BUCKET}
          type: GENERAL
        - key: SPACES_ACCESS_KEY
          value: ${SPACES_ACCESS_KEY}
          type: SECRET
        - key: SPACES_SECRET_KEY
          value: ${SPACES_SECRET_KEY}
          type: SECRET

      instance_count: 1
      instance_size_slug: professional-xs

      # Internal only - no public routes (routes key omitted)

    # Grafana - Visualization and dashboarding
    - name: grafana
      git:
        repo_clone_url: https://github.com/AppPlatform-Templates/grafana-observability-stack.git
        branch: main
      dockerfile_path: grafana/Dockerfile
      source_dir: /

      http_port: 3000

      health_check:
        http_path: /api/health
        initial_delay_seconds: 30
        period_seconds: 10
        timeout_seconds: 5
        failure_threshold: 3

      routes:
        - path: /

      envs:
        # Database configuration
        - key: GF_DATABASE_TYPE
          value: postgres
          type: GENERAL
        - key: GF_DATABASE_URL
          value: ${db.DATABASE_URL}
          type: GENERAL

        # Session storage
        - key: GF_SESSION_PROVIDER
          value: postgres
          type: GENERAL
        - key: GF_SESSION_CONN_STR
          value: ${db.DATABASE_URL}
          type: GENERAL

        # Server configuration
        - key: GF_SERVER_ROOT_URL
          value: ${APP_URL}
          type: GENERAL
        - key: GF_SERVER_DOMAIN
          value: ${APP_DOMAIN}
          type: GENERAL

        # Security
        - key: GF_SECURITY_ADMIN_USER
          value: admin
          type: GENERAL
        - key: GF_SECURITY_ADMIN_PASSWORD
          value: ${GF_SECURITY_ADMIN_PASSWORD}
          type: SECRET
        - key: GF_SECURITY_SECRET_KEY
          value: ${GF_SECURITY_SECRET_KEY}
          type: SECRET

        # Authentication
        - key: GF_AUTH_ANONYMOUS_ENABLED
          value: "false"
          type: GENERAL
        - key: GF_USERS_ALLOW_SIGN_UP
          value: "false"
          type: GENERAL

        # Paths
        - key: GF_PATHS_PROVISIONING
          value: /etc/grafana/provisioning
          type: GENERAL

        # Plugins (optional - add popular plugins)
        - key: GF_INSTALL_PLUGINS
          value: ""
          type: GENERAL

      instance_count: 1
      instance_size_slug: professional-xs

  databases:
    - name: db
      engine: PG
      version: "16"
      production: false
      cluster_name: grafana-db
